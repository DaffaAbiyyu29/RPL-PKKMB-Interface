<div class="row">
	<div class="col-lg-4">
		@if (@ViewBag.UserRole == "KSK")
		{
			<div class="my-3" style="margin-top: 40px;">
				<a class="btn" style="background-color:#0059ab; color:white;" asp-controller="jadwal" asp-action="TambahJadwal">Tambah Jadwal</a>
			</div>
		}
	</div>
	<div class="col-lg-4 float-end mb-3">
	</div>
	<div class="col-lg-4 float-end mb-3">
		<div class="form-floating">
			<select class="form-select" id="floatingSelect" name="hari" aria-label="">
				<option selected disabled>Pilih Hari</option>
				<option value="Senin">Senin</option>
				<option value="Selasa">Selasa</option>
				<option value="Rabu">Rabu</option>
				<option value="Kamis">Kamis</option>
				<option value="Jumat">Jumat</option>
				<option value="Semua">Semua Hari</option>
			</select>
			<label for="floatingSelect">Hari</label>
		</div>
	</div>
</div>

<div class="row justify-content-center mb-5">
	<div class="col-lg">
		<div class="card">
			<h5 class="card-header white-text py-4 mb-4" style="background-color: #0059AB;">
				<div class="row">
					<div class="col-10">
						<strong>Jadwal PKKMB</strong>
					</div>
					<div class="col-2">
						<select class="form-select float-end" id="tahun" name="tahun" aria-label="">
						</select>
					</div>
				</div>
			</h5>
			<div class="card-body pt-1 scrollable-table">
				<table class="table table-hover table-sm semua" style="width:100%; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden;" id="tabellist">
					<thead>
						<tr>
							<th scope="col">No</th>
							<th scope="col">Tanggal</th>
							<th scope="col">Waktu</th>
							<th scope="col">Kegiatan</th>
							<th scope="col">Tempat</th>
							@if (@ViewBag.UserRole == "KSK")
							{
								<th scope="col">Aksi</th>
							}
						</tr>
					</thead>
				</table>

				<table class="table table-hover table-sm senin" style="width:100%; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden;" id="tabellistsenin">
					<thead>
						<tr>
							<th scope="col">No</th>
							<th scope="col">Tanggal</th>
							<th scope="col">Waktu</th>
							<th scope="col">Kegiatan</th>
							<th scope="col">Tempat</th>
							@if (@ViewBag.UserRole == "KSK")
							{
								<th scope="col">Aksi</th>
							}
						</tr>
					</thead>
				</table>

				<table class="table table-hover table-sm selasa" style="width:100%; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden;" id="tabellistselasa">
					<thead>
						<tr>
							<th scope="col">No</th>
							<th scope="col">Tanggal</th>
							<th scope="col">Waktu</th>
							<th scope="col">Kegiatan</th>
							<th scope="col">Tempat</th>
							@if (@ViewBag.UserRole == "KSK")
							{
								<th scope="col">Aksi</th>
							}
						</tr>
					</thead>
				</table>

				<table class="table table-hover table-sm rabu" style="width:100%; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden;" id="tabellistrabu">
					<thead>
						<tr>
							<th scope="col">No</th>
							<th scope="col">Tanggal</th>
							<th scope="col">Waktu</th>
							<th scope="col">Kegiatan</th>
							<th scope="col">Tempat</th>
							@if (@ViewBag.UserRole == "KSK")
							{
								<th scope="col">Aksi</th>
							}
						</tr>
					</thead>
				</table>

				<table class="table table-hover table-sm kamis" style="width:100%; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden;" id="tabellistkamis">
					<thead>
						<tr>
							<th scope="col">No</th>
							<th scope="col">Tanggal</th>
							<th scope="col">Waktu</th>
							<th scope="col">Kegiatan</th>
							<th scope="col">Tempat</th>
							@if (@ViewBag.UserRole == "KSK")
							{
								<th scope="col">Aksi</th>
							}
						</tr>
					</thead>
				</table>

				<table class="table table-hover table-sm jumat" style="width:100%; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden;" id="tabellistjumat">
					<thead>
						<tr>
							<th scope="col">No</th>
							<th scope="col">Tanggal</th>
							<th scope="col">Waktu</th>
							<th scope="col">Kegiatan</th>
							<th scope="col">Tempat</th>
							@if (@ViewBag.UserRole == "KSK")
							{
								<th scope="col">Aksi</th>
							}
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
</div>

<script>
	var idpkkmb = sessionStorage.getItem('id_pkkmb')

	function TahunPkkmb() {
		var hostname = "https://localhost:7087/";
		var url = hostname + "GetAllPkkmb"
		var method = "GET";

		$.ajax({
			url: url,
			type: method,
			dataType: "json",
			success: function (response) {
				DropDownTahunPkkmb(response.data);
			},
			error: function (xhr, status, error) {
				console.log('Error fetching data:', error);
				console.log(xhr.responseJSON);
			}
		});
	}

	function DropDownTahunPkkmb(data) {
		var dropdown = $('#tahun');
		dropdown.empty();
		dropdown.append($('<option selected disabled data-idpkkmb="">Pilih Tahun</option>'));

		var options = $.map(data, function (item) {
			return $('<option></option>').val(item.pkm_idPkkmb).attr('data-idpkkmb', item.pkm_idPkkmb).text('Tahun ' + item.pkm_tahunPkkmb);
		});

		dropdown.append(options);
	}

	$('.senin').hide();
	$('.selasa').hide();
	$('.rabu').hide();
	$('.kamis').hide();
	$('.jumat').hide();
	$('.semua').show();
	//var tabel = '#tabellist';

	$(document).ready(function () {
		var hari = null;
		TahunPkkmb();

		$('#tahun').change(function () {
			var selectedYearId = $(this).find(':selected').attr('data-idpkkmb');
			var selectedYear = $(this).find(':selected').text();
			idpkkmb = selectedYearId;
			loadTable(hari);
			console.log(selectedYear, hari)
		});

		loadTable('Semua');

		$('[name="hari"]').change(function () {
			var selectedHari = $(this).val();
			hari = selectedHari;

			// Sembunyikan semua tabel terlebih dahulu
			$('.semua, .senin, .selasa, .rabu, .kamis, .jumat').hide();

			// Tampilkan tabel yang sesuai dengan pilihan hari
			if (selectedHari === 'Senin') {
				$('.senin').show();
			} else if (selectedHari === 'Selasa') {
				$('.selasa').show();
			} else if (selectedHari === 'Rabu') {
				$('.rabu').show();
			} else if (selectedHari === 'Kamis') {
				$('.kamis').show();
			} else if (selectedHari === 'Jumat') {
				$('.jumat').show();
			} else if (selectedHari === 'Semua') {
				$('.semua').show();
			}

			// Memuat data baru sesuai dengan hari yang dipilih
			loadTable(selectedHari);
		});
	});

	function loadTable(selectedHari) {
		var hostname = "https://localhost:7087/";
		var url = hostname + "GetAllJadwal?jdl_idpkkmb=" + idpkkmb;
		var method = "GET";
		var counter = 1;
		var detailData = [];
		console.log(url)

		// Pilih tabel berdasarkan hari yang dipilih
		var tabelId = '';
		if (selectedHari === 'Senin') {
			tabelId = '#tabellistsenin';
		} else if (selectedHari === 'Selasa') {
			tabelId = '#tabellistselasa';
		} else if (selectedHari === 'Rabu') {
			tabelId = '#tabellistrabu';
		} else if (selectedHari === 'Kamis') {
			tabelId = '#tabellistkamis';
		} else if (selectedHari === 'Jumat') {
			tabelId = '#tabellistjumat';
		} else {
			tabelId = '#tabellist'; // Default untuk 'Semua'
		}

		$.ajax({
			url: url,
			method: method,
			contentType: "application/json",
			success: function (data) {
				var item = data.data;

				// Gunakan filter untuk hanya menampilkan data sesuai dengan hari yang dipilih
				var filteredData = item.filter(function (val) {
					var jadwalDate = new Date(val.jdl_tglpelaksanaan);
					var formattedDate = getFormattedDate(jadwalDate);
					var hari = extractDayOfWeek(formattedDate);
					return selectedHari === 'Semua' || hari === selectedHari;
				});

				$.each(filteredData, function (key, val) {
					var aksi = '<a style="background-color: #3a4584 !important;" class="btn btn-primary" href="/Jadwal/Ubah/' + val.jdl_idjadwal + '"><i class="fa fa-pencil-alt" aria-hidden="true"></i></a>';
					var jadwalDate = new Date(val.jdl_tglpelaksanaan);
					var formattedDate = getFormattedDate(jadwalDate);
					var hari = extractDayOfWeek(formattedDate);

					if ("@ViewBag.UserRole" == "KSK") {
						detailData.push([counter, formattedDate, val.jdl_waktupelaksanaan, val.jdl_agenda, val.jdl_tempat, aksi]);
					} else {
						detailData.push([counter, formattedDate, val.jdl_waktupelaksanaan, val.jdl_agenda, val.jdl_tempat]);
					}

					counter++;
				});

				//$(tabelId).DataTable().destroy();
				$('#tabellist').DataTable().destroy();
				$('#tabellistsenin').DataTable().destroy();
				$('#tabellistselasa').DataTable().destroy();
				$('#tabellistrabu').DataTable().destroy();
				$('#tabellistkamis').DataTable().destroy();
				$('#tabellistjumat').DataTable().destroy();
				$(tabelId).DataTable({
					data: detailData,
					language: {
						search: "Cari :",
						zeroRecords: "Data Tidak Ditemukan",
						sLengthMenu: "Menampilkan _MENU_ data",
						info: "Menampilkan data ke - _START_ sampai _END_ dari _TOTAL_ data",
						infoEmpty: "Menampilkan 0 data",
						infoFiltered: "(Difilter dari _MAX_ total data)",
						paginate: {
							previous: "Sebelumnya",
							next: "Berikutnya"
						}
					}
				});
			},
		});
	}

	function getFormattedDate(date) {
		var days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
		var months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

		var formattedDate = days[date.getDay()] + ', ' +
			date.getDate() + ' ' +
			months[date.getMonth()] + ' ' +
			date.getFullYear();

		return formattedDate;
	}

	// Function to extract the day of the week
	function extractDayOfWeek(dateString) {
		var dayPart = dateString.split(',')[0];
		var trimmedDay = dayPart.trim();
		return trimmedDay;
	}
</script>
