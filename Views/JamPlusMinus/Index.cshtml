@if (ViewBag.UserRole == "Fasilitator")
{
	<div class="row">
		<div class="col-lg">
			<div class="my-3" style="margin-top: 40px;">
				<a class="btn" style="background-color:#0059ab; color:white;" asp-controller="jamplusminus" asp-action="tambahjam">Tambah Data</a>
			</div>
		</div>
	</div>
}

<div class="row justify-content-center mb-5">
	<div class="col-lg">
		<div class="card">
			<h5 class="card-header white-text py-4 mb-4" style="background-color: #0059AB;">
				<div class="row">
					<div class="col-10">
						<strong>Jam Plus / Minus Mahasiswa</strong>
					</div>
					<div class="col-2">
						<select class="form-select float-end" id="tahun" name="tahun" aria-label="">
						</select>
					</div>
				</div>
			</h5>
			<div class="card-body pt-1 scrollable-table">
				<table class="table table-hover table-sm" style="width:100%; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden;" id="tabellist">
					<thead>
						<tr>
							<th scope="col">No</th>
							<th scope="col">Nama</th>
							<th scope="col">Jenis Kelamin</th>
							<th scope="col">Program Studi</th>
							<th scope="col">Kategori</th>
							<th scope="col">Kelompok</th>
							<th scope="col">Jam Plus</th>
							<th scope="col">Jam Minus</th>
							<th scope="col">Aksi</th>
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
</div>

<script>
	var idpkkmb = sessionStorage.getItem('id_pkkmb')

	function TahunPkkmb() {
		var hostname = "https://localhost:7087/";
		var url = hostname + "GetAllPkkmb"
		var method = "GET";

		$.ajax({
			url: url,
			type: method,
			dataType: "json",
			success: function (response) {
				DropDownTahunPkkmb(response.data);
			},
			error: function (xhr, status, error) {
				console.log('Error fetching data:', error);
				console.log(xhr.responseJSON);
			}
		});
	}

	function DropDownTahunPkkmb(data) {
		var dropdown = $('#tahun');
		dropdown.empty();
		dropdown.append($('<option selected disabled data-idpkkmb="">Pilih Tahun</option>'));

		var options = $.map(data, function (item) {
			return $('<option></option>').val(item.pkm_idPkkmb).attr('data-idpkkmb', item.pkm_idPkkmb).text('Tahun ' + item.pkm_tahunPkkmb);
		});

		dropdown.append(options);
	}

	$(document).ready(function () {
		TahunPkkmb();

		$('#tahun').change(function () {
			var selectedYearId = $(this).find(':selected').attr('data-idpkkmb');
			var selectedYear = $(this).find(':selected').text();
			loadTable(selectedYearId);
		});

		loadTable(idpkkmb);
	});

	function loadTable(id_pkkmb) {
		var hostname = "https://localhost:7087/";
		var url = null
		if ('@ViewBag.UserRole' == 'Mahasiswa') {
			url = hostname + "datamahasiswa?mhs_nopendaftaran=@ViewBag.UserId"
		} else {
			url = hostname + "getallmahasiswa?mhs_idpkkmb=" + id_pkkmb
		}

		var method = "GET";
		var counter = 1;
		var detailData = []

		$('#tabellist').DataTable().clear().destroy();

		$.ajax({
			url: url,
			type: method,
			contentType: "application/json",
			success: function (data) {
				var item = data.data;
				var totalData = item.length;

				if ('@ViewBag.UserRole' == 'Mahasiswa') {
					var namaKelompok = null;

					loadNamaKelompok(item.mhs_idkelompok, function (namaKmk) {
						namaKelompok = namaKmk
						console.log(namaKelompok)
						var aksi = '<a style="background-color: #3a4584 !important;" class="btn btn-primary" href="/JamPlusMinus/DetailJam/' + item.mhs_nopendaftaran + '"><i class="fa fa-eye" aria-hidden="true"></i></a>' + '</td>';

						detailData.push([counter, item.mhs_namalengkap, item.mhs_gender, item.mhs_programstudi, item.mhs_kategori, namaKelompok, item.mhs_jamplus, item.mhs_jamminus, aksi])

						$('#tabellist').DataTable({
							data: detailData,
							language: {
								search: "Cari :",
								zeroRecords: "Data Tidak Ditemukan",
								sLengthMenu: "Menampilkan _MENU_ data",
								info: "Menampilkan data ke - _START_ sampai _END_ dari _TOTAL_ data",
								infoEmpty: "Menampilkan 0 data",
								infoFiltered: "(Difilter dari _MAX_ total data)",
								paginate: {
									previous: "Sebelumnya",
									next: "Berikutnya"
								}
							}
						});
					});
				} else {
					$.each(item, function (key, val) {
						var namaKelompok = [];

						loadNamaKelompok(val.mhs_idkelompok, function (namaKmk) {
							namaKelompok.push([namaKmk]);
							var aksi = '<a style="background-color: #3a4584 !important;" class="btn btn-primary" href="/JamPlusMinus/DetailJam/' + val.mhs_nopendaftaran + '"><i class="fa fa-eye" aria-hidden="true"></i></a>' + '</td>';

							detailData.push([counter, val.mhs_namalengkap, val.mhs_gender, val.mhs_programstudi, val.mhs_kategori, namaKelompok, val.mhs_jamplus, val.mhs_jamminus, aksi])
							counter++;

							if (counter - totalData == 1) {
								initializeDataTable(detailData);
							}
						});
					});
				}

				function initializeDataTable(data) {
					$('#tabellist').DataTable({
						data: detailData,
						language: {
							search: "Cari :",
							zeroRecords: "Data Tidak Ditemukan",
							sLengthMenu: "Menampilkan _MENU_ data",
							info: "Menampilkan data ke - _START_ sampai _END_ dari _TOTAL_ data",
							infoEmpty: "Menampilkan 0 data",
							infoFiltered: "(Difilter dari _MAX_ total data)",
							paginate: {
								previous: "Sebelumnya",
								next: "Berikutnya"
							}
						}
					});
				}
			},
			error: function (xhr, status, error) {
				console.log('Error fetching data:', error);
				console.log(xhr.responseJSON);
			}
		});
	}

	function loadNamaKelompok(id, callback) {
		var hostname = "https://localhost:7087/";
		var url = hostname + "GetKelompok?kmk_idkelompok=" + id;
		var method = "GET";

		$.ajax({
			url: url,
			method: method,
			contentType: "application/json",
			success: function (data) {
				var item = data.data;
				namaKelompok = item.kmk_namakelompok;
				callback(namaKelompok);
			},
			error: function (error) {
				console.error("Error fetching data: ", error);
			},
		});
	}
</script>